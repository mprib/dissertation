---
title: "Processing V3D Data in R"
author: "Mac Prible"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("v3d_to_tidy.R")
```

# Reproducible Research


You want to be able to recreate your entire pipeline of data processing from raw data to statistical results with minimial one-off adjustments.

Avoid doing things by hand with the idea that you'll do it once and be done with it. 
You will always have to go back to revise.
Hand edits will be forgotten.
Automate everything and make it explicit.

You want to be able to rerun the processing pipeline with your original data and get the same results.
If you do things by hand or in excel, then you cannot do that.
You also cannot scale it. 

```{r, warning=FALSE}
# Load required libraries
library(tidyverse)

# Set up variables
data_directory <- "C:\\Users\\Mac Prible\\OneDrive - The University of Texas at Austin\\research\\PDSV\\data\\PDVS_2024\\v3d"
file_name <- "left_v3d_in_R_gait_cycle_data.tsv"
output_name <- "processed_gait_cycle_data.csv"

# Construct the full path
input_path <- file.path(data_directory, file_name)
output_path <- file.path(data_directory, output_name)

tidy_data <- tsv_to_tidy(data_directory, file_name, stance_side="left")
# here I begin again by loading in the 
# tidy_data <- read_csv(output_path)
```

# Find belt speed differences
```{r}

belt_speeds <- tidy_data %>% 
  ungroup() %>% 
  filter(str_detect(variable, "Belt")) %>% 
  mutate(value = 1000*value) %>% # correct scale
  pivot_wider(names_from = variable, values_from = value) %>% 
  mutate(speed_difference = IPSI_BeltSpeed- CONTRA_BeltSpeed,
         abs_speed_difference = abs(speed_difference))

  
belt_speeds %>% 
  ggplot(aes(x = normalized_time, y = IPSI_BeltSpeed, group=step))+
  geom_line()+
  facet_grid(rows=vars(condition), cols = vars(start_stop))

```


```{r}

max_speed_diff <- belt_speeds %>% 
  group_by(subject, order,condition,start_stop, stance_side,axis, step) %>% 
  summarize(max_speed_diff = max(abs_speed_difference)) 

max_speed_diff %>%  
  ggplot(aes(x = step, y = max_speed_diff))+
  geom_point()+
  facet_grid(rows=vars(condition), cols = vars(start_stop))

```


```{r}


find_change_point <- function(data, window_size = 5) {
  n <- nrow(data)
  max_diff <- 0.5
  change_point <- NA
  
  for (i in (window_size + 1):(n - window_size)) {
    mean1 <- mean(data$max_speed_diff[(i-window_size):(i-1)])
    mean2 <- mean(data$max_speed_diff[i:(i+window_size-1)])
    diff <- abs(mean2 - mean1)
    if (diff > max_diff) {
      max_diff <- diff
      change_point <- data$step[i]
    }
  }
  
  return(change_point)
}


results <- max_speed_diff %>%
  group_by(condition, start_stop) %>%
  summarize(change_point = find_change_point(cur_data())) %>% 
  ungroup()
 
include_count <- 5
# Join the change points with the original data
max_speed_diff_with_periods <- max_speed_diff %>%
  left_join(results, by = c("condition", "start_stop")) %>%
  group_by(condition, start_stop) %>%
  mutate(period = case_when(
    start_stop == "start" & step >= (change_point - include_count -1) & step < change_point-1 ~ "Late Baseline",
    start_stop == "start" & step > change_point & step < (change_point + include_count +1 ) ~ "Early Adaptation",
    start_stop == "stop" & step >= (change_point - include_count -1) & step < change_point-1 ~ "Late Adaptation",
    start_stop == "stop" & step > change_point & step < (change_point + include_count +1) ~ "Early Post Adaptation",
    TRUE ~ NA_character_
  )) %>% 
  ungroup()


# Add the change points to the original plot
max_speed_diff_with_periods %>%
  ggplot(aes(x = step, y = max_speed_diff, color=period)) +
  geom_point() +
  geom_vline(data = results, aes(xintercept = change_point), color = "red", linetype = "dashed") +
  facet_grid(rows = vars(condition), cols = vars(start_stop)) +
  labs(title = "Belt Speed Difference with Detected Change Points",
       x = "Step",
       y = "Max Speed Difference")

# Print the detected change points
print(results)



```