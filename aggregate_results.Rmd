---
title: "Aggregate Data"
author: "Mac Prible"
date: "2024-11-06"
output: html_document
---

# Import Data
```{r, warning=FALSE, message=FALSE}
library(tidyverse)

tidy_data_directory <- "C:\\Users\\Mac Prible\\OneDrive - The University of Texas at Austin\\research\\PDSV\\data\\PDVS_2024\\v3d\\tidy_output"

mean_across_stance <- 
  list.files(tidy_data_directory, pattern="*_mean_across_stance.csv") %>% 
  map_df(~read_csv2(file.path(tidy_data_directory,.)))
  
step_lengths <- 
  list.files(tidy_data_directory, pattern="*_step_lengths.csv") %>% 
  map_df(~read_csv2(file.path(tidy_data_directory,.)))
```

## Get Stance Times
```{r}
stance_times <- mean_across_stance %>% 
  filter(variable %in% c("TIME") & axis == "X") %>% 
  group_by(subject, condition, period, stance_side, normalized_time) %>% 
  summarize(time = mean(value)) %>% 
  ungroup() %>% 
  group_by(subject, condition, period, stance_side) %>%   
  summarize(start_stance = min(time),
            stop_stance = max(time)) %>% 
  ungroup() %>% 
  mutate(stance_time = stop_stance - start_stance)

```


# Study 2: Unilateral PDSV

## Step Length Ratio (SLR)

```{r}
primary_periods <- c("Late Baseline", "Early Adapt" , "Late Adapt", "Early Post Adapt")

plt_SLR <- step_lengths %>% 
  filter(period %in% primary_periods) %>% 
  filter(condition %in% c("sbt", "ubp","upp")) %>% 
  mutate(period = factor(period, levels = primary_periods)) %>% 
  group_by(subject, condition, period, stance_side) %>% 
  summarize(step_length = mean(step_length)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = stance_side, values_from = step_length, names_glue = "{stance_side}_step_length") %>% 
  mutate(SLR = left_step_length/right_step_length) %>% 
  ggplot(aes(x=period, y = SLR, group = subject, color=subject))+
  geom_point()+
  geom_line()+
  geom_hline(yintercept =1, linetype="dashed")+
  facet_grid(cols=vars(condition))+
  theme(plot.title = element_text(hjust = 0.5,),
        plot.caption = element_text(hjust = 0.5, size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1),   # Add this line
        legend.position = "bottom")+
  labs(title = "SLR Across Treadmill Protocol")

plt_SLR

plt_SLR +
  stat_summary(aes(group = 1), fun = mean, geom = "line", color = "black", size = 0.8, linetype = "dashed", alpha=.6) +  # Thinner, dashed mean line
  stat_summary(aes(group = 1), fun = mean, geom = "point", color = "black", size = 3, shape = 18) +  # Smaller mean points
  geom_text(stat = "summary", fun = mean,
            aes(label = sprintf("%.2f", ..y..), group = 1,
                # hjust = ifelse(period %in% c("Baseline"), 1.5, -1)
                ),
            color = "black", vjust = -0.5, size = 4, fontface = "bold",
            bg.color = "white", bg.r = 0.15)

```


# Ankle PF Torque

## By Subject
```{r, fig.width=10, fig.height=6}
periods = c("Late Baseline", "Early Post Adapt")
mean_across_stance %>% 
  filter(period %in% periods) %>% 
  mutate(period = factor(period,levels = periods)) %>% 
  filter(variable %in% c("IPSI_ANKLE_MOMENT") & axis == "X") %>% 
  ggplot(aes(x=normalized_time,y= value, linetype=period, color=condition))+
  geom_line()+
  geom_hline(yintercept = 0)+
  scale_x_continuous(labels=NULL)+
  facet_grid(subject~condition + stance_side)+
  scale_linetype_manual(values=c("Early Post Adapt"="solid", "Late Baseline"="dashed")) +
  theme(legend.position="bottom")+
  labs(
    x = "Normalized Stance Time (0-100%)",
    y = "Ankle PF Torque (N.m/BW)",
    title = "Ankle Torque Across Conditions",
    subtitle = "Averaged Across 5 Steps",
    color = "Condition"
  )


```


## Characteristic Curve Across Subjects

```{r, fig.height=10, fig.height=4}
periods = c("Late Baseline", "Early Post Adapt")

mean_across_stance %>% 
  filter(period %in% periods) %>% 
  mutate(period = factor(period,levels = periods)) %>% 
  filter(variable %in% c("IPSI_ANKLE_MOMENT") & axis == "X") %>% 
  group_by(period, condition, variable, normalized_time,stance_side) %>% 
  summarize(PF_torque = mean(value)) %>% 
  ggplot(aes(x=normalized_time,y= PF_torque, linetype=period, color=condition))+
  geom_line()+
  geom_hline(yintercept = 0)+
  scale_x_continuous(labels=NULL)+
  facet_grid(rows=vars(condition),
             cols=vars(stance_side))+
  scale_linetype_manual(values=c("Early Post Adapt"="solid", "Late Baseline"="dashed")) +
  # theme(legend.position="bottom")+
  labs(
    x = "Normalized Stance Time (0-100%)",
    y = "Ankle PF Torque (N.m/BW)",
    title = "Ankle Torque Across Conditions",
    subtitle = "Averaged Across Subjects",
    color = "Condition"
  )

```

## PF Impulse


```{r}

periods = c("Late Baseline", "Early Post Adapt")

PF_impulse <- mean_across_stance %>% 
  filter(period %in% periods) %>% 
  mutate(period = factor(period,levels = periods)) %>% 
  filter(variable %in% c("IPSI_ANKLE_MOMENT") & axis == "X") %>% 
  group_by(subject, period, condition, variable, normalized_time,stance_side) %>% 
  summarize(PF_torque = mean(value)) %>% 
  filter(PF_torque<0) %>%
  group_by(subject, stance_side,condition, period) %>% 
  summarize(PF_impulse = sum(PF_torque)/-100)

PF_impulse %>% 
  ggplot(aes(x = period,y=PF_impulse, group = subject, color=subject))+
  geom_point()+
  geom_line()+
  facet_grid(stance_side ~ condition)

```


```{r, fig.width=10, fig.height=6}
periods = c("Late Baseline", "Early Post Adapt")

mean_across_stance %>% 
  filter(period %in% periods) %>% 
  mutate(period = factor(period,levels = periods)) %>% 
  filter(variable %in% c("PELVIS_COM") & axis == "Z") %>%
  
  ggplot(aes(x=normalized_time,y= value, linetype=period, color=condition))+
  geom_line()+
  scale_x_continuous(labels=NULL)+
  facet_grid(subject~condition + stance_side, scales="free_y")+
  scale_linetype_manual(values=c("Early Post Adapt"="solid", "Late Baseline"="dashed")) +
  theme(legend.position="bottom")+
  labs(
    x = "Normalized Stance Time (0-100%)",
    y = "Ankle PF Torque (N.m/BW)",
    title = "Ankle Torque Across Conditions",
    subtitle = "Averaged Across 5 Steps",
    color = "Condition"
  )
```

