---
title: "Roll Up of Python Data"
format: html
editor: source
---

# Import All Long Data 

```{r}
# note that measured_data_long.csv is created by a python script `v3d_import.py`
library(readxl)
library(tidyverse)
RAW_OUTPUT_FOLDER <- "C:\\Users\\Mac Prible\\OneDrive - The University of Texas at Austin\\research\\PDSV\\data\\PDVS_2024\\v3d"

participant_count <- 3
# Create an empty list to store individual data tables
data_list <- list()


for (i in 1:participant_count) {
  print(paste0("Processing output for participant ", i))
  measured_data_long <- read.csv(paste0(RAW_OUTPUT_FOLDER,"\\", "S",i,"_measured_data_long.csv"))
  data_list[[i]] <- measured_data_long
}

all_data_long <- bind_rows(data_list)

rm(data_list)
rm(measured_data_long)

```


# Average normalized variables and Clean Up

Averages across relevant stance phases. Rename variables so that they are in terms of "ipsilateral" and "contralateral" to ease downstream processing.

```{r}
all_normalized_stance_data <- all_data_long %>% 
  ungroup() %>% 
  select(-MaxSpeedDiff) %>% 
  mutate(Participant = parse_number(Participant)) %>% 
  group_by(Condition, Side, Participant, StartStop, Period, ConditionOrder, VariableAxis, NormalizedTimeStep) %>% 
  summarize(AverageValue = mean(Value, na.rm=TRUE)) %>% 
  separate(VariableAxis, into = c("Variable", "Axis"), sep = "_(?=[^_]+$)", extra = "merge") %>% 
  mutate(Variable = case_when(
    Variable == "RHEEL" ~ "R_HEEL",
    Variable == "LHEEL" ~ "L_HEEL",
    Variable == "FP1" ~ "Left_GRF",
    Variable == "FP2" ~ "Right_GRF",
    TRUE ~ Variable  # This keeps all other values unchanged
  )) %>% 
    mutate(NewVariable = case_when(
    Side == "left" & grepl("^(L_|Left)", Variable) ~ sub("^(L_|Left_|Left)", "IPSI_", Variable),
    Side == "right" & grepl("^(R_|Right)", Variable) ~ sub("^(R_|Right_|Right)", "IPSI_", Variable),
    Side == "right" & grepl("^(L_|Left)", Variable) ~ sub("^(L_|Left_|Left)", "CONTRA_", Variable),
    Side == "left" & grepl("^(R_|Right)", Variable) ~ sub("^(R_|Right_|Right)", "CONTRA_", Variable),
    TRUE ~ Variable # Keeps all other values unchanged
  ))


# rm(measured_data_long)
```

# Check Ipsi/Contra Language


```{r}
# get list of variable names
all_normalized_stance_data %>% 
  ungroup() %>% 
  select(NewVariable, Side, Variable) %>% 
  group_by(NewVariable, Side) %>% 
  summarize(NewVariable = first(NewVariable),
            OriginalVariable = first(Variable))
```


# Unilateral PDSV Impact on Ankle PF

```{r }
figure_participant <- 2

all_normalized_stance_data %>% 
  filter(Participant == figure_participant) %>%  
  filter(Period %in% c("Baseline", "PostAdapt")) %>% 
  filter(Condition %in% c("sbt", "ubp", "upp")) %>% 
  mutate(Condition = case_when(
    Condition == "sbt" ~ "cSBT",
    Condition == "ubp" ~ "FastBrake",
    Condition == "upp" ~ "FastProp"
  )) %>% 
  filter(Axis %in% c("X")) %>% 
  # filter(NewVariable == "HEEL_DISTANCE") %>% 
  filter(NewVariable == "IPSI_ANKLE_MOMENT") %>% 
  ggplot(aes(x=NormalizedTimeStep, y = AverageValue, color=Period))+
  geom_line()+
  facet_grid(cols = vars(Side), rows = vars(Condition), scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "bottom",
        plot.caption = element_text(hjust = 0.5, size=13)) +  # Center-justify the caption
  labs(title = paste0("Subject ", figure_participant, ": Ankle Torque Profile Before and After 6 Minutes of Adaptation") ,
       subtitle = "Tested Conditions: cSBT, FastBrake, FastProp",
       caption = str_wrap("Ankle torque on the left (altered) side is decreased following cSBT and FastBrake, but increases following adaptation to FastProp", width = 80),
       x = "% stance",
       y = "Torque (N.m/BW)",
       )

```


# Bilateral PDSV Impact on Ankle PF

```{r}
figure_participant <- 2

all_normalized_stance_data %>% 
  filter(Participant == figure_participant) %>%  
  filter(Period %in% c("Baseline", "PostAdapt")) %>% 
  filter(Condition %in% c("bbp", "bpp")) %>% 
  mutate(Condition = case_when(
    Condition == "bbp" ~ "Bilateral FastBrake",
    Condition == "bpp" ~ "Bilateral FastProp"
  )) %>% 
  filter(Axis %in% c("X")) %>% 
  filter(NewVariable == "IPSI_ANKLE_MOMENT") %>% 
  ggplot(aes(x=NormalizedTimeStep, y = AverageValue, color=Period))+
  geom_line()+
  facet_grid(cols = vars(Side), rows = vars(Condition), scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "bottom")+
  labs(x="% Stance",
       y = "Torque (N.m/BW)")
```

# Get Normalized Stance Time

```{r}

stance_times <-all_normalized_stance_data %>% 
  ungroup() %>% 
  filter(Axis == "X") %>% 
  filter(NewVariable %in% c("TIME")) %>% 
  filter(Period %in% c("Baseline", "PostAdapt")) %>%
  group_by(Participant, Condition, Period, Side) %>% 
  summarize(min = min(AverageValue), max = max(AverageValue)) %>%
  mutate(stance_time = max-min)

PF_impulse_time_normalized <- all_normalized_stance_data %>% 
  ungroup() %>% 
  filter(Axis == "X") %>% 
  filter(NewVariable %in% c("IPSI_ANKLE_MOMENT")) %>% 
  filter(AverageValue < 0) %>%  # interested in PF not DF
  filter(Period %in% c("Baseline", "PostAdapt")) %>%
  group_by(Participant, Condition, Period, Side) %>% 
  summarize(PF_impulse_time_norm = sum(AverageValue/100))

PF_impulse_by_condition_participant <-stance_times %>% left_join(PF_impulse_time_normalized) %>% 
  ungroup() %>% 
  mutate(PF_impulse_BW_normalized =  PF_impulse_time_norm * stance_time) %>% 
  filter(Side=="left") %>% 
  select(Participant, Condition, Period, PF_impulse_BW_normalized) %>% 
  mutate(PF_impulse_time_normalized=abs(PF_impulse_BW_normalized)) %>% 
  pivot_wider(id_cols=c(Participant, Condition), values_from = PF_impulse_time_normalized, names_from = Period) %>% 
  mutate(pct_change = (PostAdapt-Baseline)/Baseline)


```
# Plot PF Impulse

```{r}

PF_impulse_plot_data <- PF_impulse_by_condition_participant %>%
  gather(key = "Period", value = "PF_Impulse", Baseline, PostAdapt)


ggplot(PF_impulse_plot_data, aes(x = Period, y = PF_Impulse, color = factor(Participant), group = Participant)) +
  geom_point(size = 3) +
  geom_line() +
  facet_grid(cols=vars(Condition)) +
  labs(x = "Period", y = "PF Impulse", title = "PF Impulse by Period and Condition", color = "Participant") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# SLR change across periods by condition

```{r}


all_normalized_stance_data %>% 
  ungroup() %>% 
  filter(NormalizedTimeStep==1) %>% 
  filter(Axis == "X") %>% 
  filter(NewVariable %in% c("HEEL_DISTANCE")) %>% 
  filter(Period %in% c("PostAdapt")) %>% 
  filter(Condition %in% c("sbt", "ubp", "upp")) %>% 
  mutate(Condition = case_when(
    Condition == "sbt" ~ "cSBT",
    Condition == "ubp" ~ "FastBrake",
    Condition == "upp" ~ "FastProp"
  )) %>% 
  mutate(StepLength = abs(AverageValue)) %>% 
  select(-c(StartStop, Axis, ConditionOrder, Variable, NewVariable, NormalizedTimeStep,AverageValue)) %>% 
  pivot_wider(names_from = Side, values_from = StepLength) %>% 
  mutate(SLR = left/right)

all_normalized_stance_data %>% 
  ungroup() %>% 
  filter(NormalizedTimeStep==1) %>% 
  filter(Axis == "X") %>% 
  filter(NewVariable %in% c("HEEL_DISTANCE")) %>% 
  filter(Condition %in% c("sbt", "ubp", "upp")) %>% 
  mutate(Condition = case_when(
    Condition == "sbt" ~ "cSBT",
    Condition == "ubp" ~ "FastBrake",
    Condition == "upp" ~ "FastProp"
  )) %>% 
  mutate(StepLength = abs(AverageValue)) %>% 
  select(-c(StartStop, Axis, ConditionOrder, Variable, NewVariable, NormalizedTimeStep,AverageValue)) %>% 
  pivot_wider(names_from = Side, values_from = StepLength) %>% 
  mutate(SLR = left/right) %>% 
  ggplot(aes(x=Period, y = SLR, group = Participant, color=factor(Participant)))+
  geom_point()+
  geom_line()+
  geom_hline(yintercept =1, linetype="dashed")+
  facet_grid(rows=vars(Condition))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5,),
        plot.caption = element_text(hjust = 0.5, size = 13),
        legend.position = "bottom")+
  labs(title = "SLR Across Treadmill Protocol")
  
```

# step Length in a body frame of reference

Reviewing this calculations I think there are some problems with the way I went about it. Definitely want to go over these calcs with a fine-toothed comb.


```{r}
measured_data_long %>% 
  ungroup() %>% 
  filter(NormalizedTimeStep==1) %>% 
  # filter(Condition %in% c("sbt", "ubp", "upp")) %>%
  filter(Condition %in% c("bbp", "bpp")) %>%
  filter(Period %in% c("Baseline", "PostAdapt")) %>%
  separate(VariableAxis, into = c("Variable", "Axis"), sep = "_(?=[^_]+$)", extra = "merge") %>% 
  filter(Axis == "Y") %>% 
  filter(Variable %in% c("RHEEL", "LHEEL", "PELVIS_COM")) %>% 
  mutate(Variable = case_when(
    Variable == "RHEEL" ~ "R_HEEL",
    Variable == "LHEEL" ~ "L_HEEL",
    TRUE ~ Variable  # This keeps all other values unchanged
  )) %>% 
    mutate(NewVariable = case_when(
    Side == "left" & grepl("^(L_|Left)", Variable) ~ sub("^(L_|Left_|Left)", "IPSI_", Variable),
    Side == "right" & grepl("^(R_|Right)", Variable) ~ sub("^(R_|Right_|Right)", "IPSI_", Variable),
    Side == "right" & grepl("^(L_|Left)", Variable) ~ sub("^(L_|Left_|Left)", "CONTRA_", Variable),
    Side == "left" & grepl("^(R_|Right)", Variable) ~ sub("^(R_|Right_|Right)", "CONTRA_", Variable),
    TRUE ~ Variable # Keeps all other values unchanged
  )) %>% 
  select(-c(Axis, NormalizedTimeStep,StartStop, Variable, MaxSpeedDiff, ConditionOrder)) %>% 
  pivot_wider(names_from = NewVariable, values_from = Value) %>% 
  mutate(AnteriorStep = -(IPSI_HEEL-PELVIS_COM),
         PosteriorStep = CONTRA_HEEL-PELVIS_COM,
         Step = -(IPSI_HEEL - CONTRA_HEEL)) %>% 
  select(-c(PELVIS_COM, CONTRA_HEEL, IPSI_HEEL)) %>% 
  group_by(Condition, Side, Participant,Period) %>% 
  summarise(AnteriorStep = mean(AnteriorStep),
            PosteriorStep = mean(PosteriorStep),
            Step = mean(Step)) %>% 
  pivot_longer(cols = c(AnteriorStep, PosteriorStep, Step)) %>% 
  ungroup() %>% 
  ggplot(aes(x=Period, y = value, 
             color = Condition,
             group = Condition))+
  geom_point()+
  geom_line()+
  facet_grid(cols=vars(Side), rows = vars(name))

```

```{r}
all_normalized_stance_data %>% 
  filter(Period %in% c("Late Adapt")) %>%
  filter(NewVariable == "IPSI_BeltSpeed") %>% 
  mutate(Condition = case_when(
    Condition == "sbt" ~ "cSBT",
    Condition == "ubp" ~ "U. FastBrake",
    Condition == "upp" ~ "U. FastProp",
    Condition == "bbp" ~ "B. FastBrake",
    Condition == "bpp" ~ "B. FastProp"
  )) %>% 
  mutate(Condition = factor(Condition, levels = c("cSBT", "U. FastBrake", "U. FastProp", "B. FastBrake", "B. FastProp"))) %>% 
  ggplot(aes(x=NormalizedTimeStep, y = AverageValue, color=Period))+
  geom_line()+
  facet_grid(cols = vars(Participant, Side), rows = vars(Condition))+
  theme_minimal()+
  theme( legend.position = "none",
        plot.caption = element_text(hjust = 0, size = 13),
        strip.text.y = element_text( angle=0))+
  labs(title = "Belt Speed Across Stance Phase By Condition",
       subtitle = "Adaptation Belt Speeds for Aims 1 and 2",
       x = "% Stance",
       y = "Belt Speed (m/s)",
       caption = str_wrap("Actual belt speed captured using retroreflective markers attached to the belt. Speed change triggered when leading limb vertical GRF exceeds trailing limb vertical GRF. Belt acceleration capped at 3 m/(s^2).", width = 80))

all_normalized_stance_data %>% 
  filter(Period %in% c("Late Adapt")) %>%
  filter(Axis == "Z") %>% 
  filter(NewVariable %in% c("IPSI_GRF", "CONTRA_GRF")) %>% 
  
  ggplot(aes(x=NormalizedTimeStep, y = AverageValue, group = NewVariable, color = NewVariable))+
  geom_line()+
  facet_grid(cols = vars(Participant,Side), rows = vars(Axis, Condition))+
  theme_minimal()
```

