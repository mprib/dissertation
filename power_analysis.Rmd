---
title: "Power Analysis"
author: "Mac Prible"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(lme4)
library(emmeans)
library(dplyr)
library(tidyr)
```

# Simulate data

This will involve getting 

```{r}

# Number of participants
n <- 10

# Function to generate simulated data
generate_sim_data <- function(n, condition_name, period_name, mean_slr, var_slr, mean_pf, var_pf) { # Generate baseline data
  
  # Generate post-adaptation data
  slr <- rnorm(n, mean = mean_slr, sd = sqrt(var_slr))
  pf_impulse <- rnorm(n, mean = mean_pf, sd = sqrt(var_pf))

  condition <- rep(condition_name, n)
  period <- rep(period_name,n)
  participant <- seq_len(n)
  
  return(data.frame(participant, condition, period, slr, pf_impulse))
}

# Parameters for cSBT
cSBT_baseline_params <- list(condition_name = "cSBT", 
                    period_name = "Baseline",
                    mean_slr = 1, 
                    var_slr = 0.06, 
                    mean_pf = 450, 
                    var_pf = 150 )
                    
cSBT_post_params <- list(condition_name = "cSBT", 
                    period_name = "PostAdapt",
                    mean_slr = 1.4, 
                    var_slr = 0.15,
                    mean_pf = 400, 
                    var_pf = 150)

# Parameters for FastBraking (Example values, adjust as needed)
FastBraking_baseline_params <- list(condition_name = "FastBrake", 
                           period_name = "Baseline",
                           mean_slr = 1, 
                           var_slr = 0.06, 
                           mean_pf = 450, 
                           var_pf = 150)                           
                           
FastBraking_post_params <- list(condition_name = "FastBrake", 
                           period_name = "PostAdapt",
                           mean_slr = 1.3, 
                           var_slr = 0.14,
                           mean_pf = 400, 
                           var_pf = 145)

# Parameters for FastPropulsion (Example values, adjust as needed)
FastPropulsion_baseline_params <- list(condition_name = "FastProp", 
                              period_name = "Baseline",
                              mean_slr = 1, 
                              var_slr = 0.06, 
                              mean_pf = 450, 
                              var_pf = 150)

FastPropulsion_post_params <- list(condition_name = "FastProp", 
                              period_name = "PostAdapt",
                              mean_slr = 1.3, 
                              var_slr = 0.16,
                              mean_pf = 500, 
                              var_pf = 155)

# Generate simulated data
cSBT_baseline_data <- do.call(generate_sim_data, c(list(n), cSBT_baseline_params))
cSBT_post_data <- do.call(generate_sim_data, c(list(n), cSBT_post_params))
FastBraking_baseline_data <- do.call(generate_sim_data, c(list(n), FastBraking_baseline_params))
FastBraking_post_data <- do.call(generate_sim_data, c(list(n), FastBraking_post_params))
FastPropulsion_baseline_data <- do.call(generate_sim_data, c(list(n), FastPropulsion_baseline_params))
FastPropulsion_post_data <- do.call(generate_sim_data, c(list(n), FastPropulsion_post_params))


sim_data = rbind(cSBT_baseline_data,  
                 cSBT_post_data, 
                 FastBraking_baseline_data, 
                 FastBraking_post_data, 
                 FastPropulsion_baseline_data, 
                 FastPropulsion_post_data)

# Pivot data wider
rm(list = setdiff(ls(),"sim_data"))

# Reshape data: wide format to have baseline and post-adaptation SLR for each participant
sim_data_wide <- sim_data %>%
  pivot_wider(names_from = period, values_from = c(slr, pf_impulse), names_sep = "_") %>%
  mutate(change_in_slr = slr_PostAdapt - slr_Baseline,
         change_in_pf_impulse = pf_impulse_PostAdapt - pf_impulse_Baseline)




head(sim_data)
```

## Visualize results


```{r}
library(ggplot2)

ggplot(sim_data, aes(x=period, y=slr, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter(, width=0.2) + # Jittered scatter points, colored by condition
  geom_line(aes(group=participant), alpha=0.5) + # Lines connecting same participants
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  stat_summary(fun=mean, geom="line", aes(group=condition, color=condition), size=1) + # Connect mean points with line
  labs(title="Step Length Ratio (SLR)",
       x="Period",
       y="SLR") +
  facet_wrap(~condition) + # Use facet_wrap for separate plots per condition
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), # Adjust text angle for readability
        legend.position="bottom") # Move legend to bottom


```

```{r}
library(ggplot2)

ggplot(sim_data, aes(x=period, y=pf_impulse, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter(, width=0.2) + # Jittered scatter points, colored by condition
  geom_line(aes(group=participant), alpha=0.5) + # Lines connecting same participants
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  stat_summary(fun=mean, geom="line", aes(group=condition, color=condition), size=1) + # Connect mean points with line
  labs(title="Plantarflexor Impulse",
       x="Period",
       y="SLR") +
  facet_wrap(~condition) + # Use facet_wrap for separate plots per condition
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), # Adjust text angle for readability
        legend.position="bottom") # Move legend to bottom

```
```{r}


# Model with SLR as the response, fixed effects for condition and period, and random intercepts for participants
model <- lmer(slr ~ condition * period + (1|participant), data = sim_data)

# Summary of the model to check fixed effects estimates
summary(model)

```
```{r}
# Estimated marginal means
emm <- emmeans(model, ~ condition | period)

# Pairwise comparisons
pairwise <- pairs(emm)
print(pairwise)

# Adjust for multiple comparisons, e.g., using Tukey method
pairwise_adj <- pairs(emm, adjust = "bonferroni")
print(pairwise_adj)

```


## Plot Change Scores


```{r}

ggplot(sim_data_wide, aes(x=condition, y=change_in_slr, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter(, width=0.2) + # Jittered scatter points, colored by condition
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  labs(title="Change in SLR",
       x="Condition",
       y="change in SLR") +
  theme_minimal() +
  theme( legend.position="none") # Move legend to bottom


ggplot(sim_data_wide, aes(x=condition, y=change_in_pf_impulse, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter(, width=0.2) + # Jittered scatter points, colored by condition
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  labs(title="Change in Plantarflexor Impulse",
       x="Condition",
       y="change in SLR") +
  theme_minimal() +
   theme( legend.position="none") # Move legend to bottom     
```