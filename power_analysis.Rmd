---
title: "Power Analysis"
author: "Mac Prible"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(dplyr)
library(tidyr)
library(rstatix)
library(ggpubr)
library(ez)
library(emmeans)

```

# Simulate data

This will involve getting 

```{r}

# Number of participants
n <- 30

# Function to generate simulated data
generate_sim_data <- function(n, condition_name, period_name, mean_slr, var_slr, mean_pf, var_pf) { # Generate baseline data
  
  # Generate post-adaptation data
  slr <- rnorm(n, mean = mean_slr, sd = sqrt(var_slr))
  pf_impulse <- rnorm(n, mean = mean_pf, sd = sqrt(var_pf))

  condition <- rep(condition_name, n)
  period <- rep(period_name,n)
  participant <- seq_len(n)
  
  return(data.frame(participant, condition, period, slr, pf_impulse))
}

# Parameters for cSBT
cSBT_baseline_params <- list(condition_name = "cSBT", 
                    period_name = "Baseline",
                    mean_slr = 1, 
                    var_slr = 0.0036, 
                    mean_pf = 450, 
                    var_pf = 150 )
                    
cSBT_post_params <- list(condition_name = "cSBT", 
                    period_name = "PostAdapt",
                    mean_slr = 1.4, 
                    var_slr = 0.07,
                    mean_pf = 400, 
                    var_pf = 150)

# Parameters for FastBraking (Example values, adjust as needed)
FastBraking_baseline_params <- list(condition_name = "FastBrake", 
                           period_name = "Baseline",
                           mean_slr = 1, 
                           var_slr = 0.0036, 
                           mean_pf = 450, 
                           var_pf = 150)                           
                           
FastBraking_post_params <- list(condition_name = "FastBrake", 
                           period_name = "PostAdapt",
                           mean_slr = 1.2, 
                           var_slr = 0.07,
                           mean_pf = 400, 
                           var_pf = 300)

# Parameters for FastPropulsion (Example values, adjust as needed)
FastPropulsion_baseline_params <- list(condition_name = "FastProp", 
                              period_name = "Baseline",
                              mean_slr = 1, 
                              var_slr = 0.0036, 
                              mean_pf = 450, 
                              var_pf = 300)

FastPropulsion_post_params <- list(condition_name = "FastProp", 
                              period_name = "PostAdapt",
                              mean_slr = 1.2, 
                              var_slr = 0.07,
                              mean_pf = 500, 
                              var_pf = 300)

# Generate simulated data
cSBT_baseline_data <- do.call(generate_sim_data, c(list(n), cSBT_baseline_params))
cSBT_post_data <- do.call(generate_sim_data, c(list(n), cSBT_post_params))
FastBraking_baseline_data <- do.call(generate_sim_data, c(list(n), FastBraking_baseline_params))
FastBraking_post_data <- do.call(generate_sim_data, c(list(n), FastBraking_post_params))
FastPropulsion_baseline_data <- do.call(generate_sim_data, c(list(n), FastPropulsion_baseline_params))
FastPropulsion_post_data <- do.call(generate_sim_data, c(list(n), FastPropulsion_post_params))


sim_data = rbind(cSBT_baseline_data,  
                 cSBT_post_data, 
                 FastBraking_baseline_data, 
                 FastBraking_post_data, 
                 FastPropulsion_baseline_data, 
                 FastPropulsion_post_data)

# Convert factors if not already done
sim_data$participant <- factor(sim_data$participant)
sim_data$condition <- factor(sim_data$condition)
sim_data$period <- factor(sim_data$period)

# Pivot data wider
rm(list = setdiff(ls(),"sim_data"))


head(sim_data)
```

## Visualize results


```{r}

ggplot(sim_data, aes(x=period, y=slr, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter(, width=0.2) + # Jittered scatter points, colored by condition
  geom_line(aes(group=participant), alpha=0.5) + # Lines connecting same participants
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  stat_summary(fun=mean, geom="line", aes(group=condition, color=condition), size=1) + # Connect mean points with line
  labs(title="Step Length Ratio (SLR)",
       x="Period",
       y="SLR") +
  facet_wrap(~condition) + # Use facet_wrap for separate plots per condition
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), # Adjust text angle for readability
        legend.position="bottom") # Move legend to bottom


```

```{r}
library(ggplot2)

ggplot(sim_data, aes(x=period, y=pf_impulse, )) +
  geom_boxplot(width =0.2, alpha=0.5) + # Boxplot with semi-transparent fill
  geom_jitter( width=0.2) + # Jittered scatter points, colored by condition
  geom_line(aes(group=participant), alpha=0.5) + # Lines connecting same participants
  stat_summary(fun=mean, geom="point", aes(group=condition, color=condition), shape=18, size=3) + # Plot mean points
  stat_summary(fun=mean, geom="line", aes(group=condition, color=condition), size=1) + # Connect mean points with line
  labs(title="Plantarflexor Impulse",
       x="Period",
       y="PF Impulse") +
  facet_wrap(~condition) + # Use facet_wrap for separate plots per condition
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), # Adjust text angle for readability
        legend.position="bottom") # Move legend to bottom

```
# Statistical Analysis

Following basic guidelines (here)[https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/#two-way-repeated-measures-anova]

## Identify Outliers
```{r}

sim_data %>% 
  group_by(condition, period) %>% 
  identify_outliers(slr)


sim_data %>% 
  group_by(condition, period) %>% 
  identify_outliers(pf_impulse)

```


## Assess Normality Assumption


### Shapiro-Wilks   
```{r}

sim_data %>% 
  group_by(condition, period) %>% 
  shapiro_test(slr) %>% 
  filter(p < .05)

sim_data %>% 
  group_by(condition, period) %>% 
  shapiro_test(slr) %>% 
  filter(p < .05)

```

### QQ plot

```{r}
ggqqplot(sim_data, "slr", ggtheme = theme_bw()) +
  facet_grid(period ~ condition, labeller = "label_both")

```
## Assess Sphericity



# ANOVA
```{r}
slr_anova <- anova_test(
      data = sim_data,
      dv = slr,
      wid = participant,
      within = c(condition,period)) %>% 
  get_anova_table() 

slr_anova


```

```{r}
sim_data %>% 
  group_by(condition) %>% 
  pairwise_t_test(
    slr ~ period, 
    paired=TRUE, 
    p.adjust.method = "bonferroni")

```

```{r}
anova_test(
      data = sim_data,
      dv = pf_impulse,
      wid = participant,
      within = c(condition,period)) %>% 
  get_anova_table()
```