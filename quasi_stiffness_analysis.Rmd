---
title: "Ankle Quasi-stiffness"
author: "Mac Prible"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(error = TRUE)
options(error = function() traceback(2))
```


# Import Data
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(lme4)
library(emmeans)

tidy_data_directory <- "C:\\Users\\Mac Prible\\OneDrive - The University of Texas at Austin\\research\\PDSV\\data\\dissertation\\v3d\\tidy_output"

figure_directory <- "C:\\Users\\Mac Prible\\OneDrive - The University of Texas at Austin\\research\\PDSV\\data\\dissertation\\figures"

mean_across_stance <- 
  list.files(tidy_data_directory, pattern="*_mean_across_stance.csv") %>% 
  map_df(~read_csv2(file.path(tidy_data_directory,.)))
  
```


## Define Conditions and Periods

```{r}
UNI_CONDITION_LABELS <- c(
  "sbt" = "Conventional SBT",
  "ubp" = "Uni. Fast Brake",
  "upp" = "Uni. Fast Prop"
)

BIL_CONDITION_LABELS <- c(
  "bbp" = "Bil. Fast Brake",
  "bpp" = "Bil. Fast Prop"
)

CONDITION_LABELS <- c(UNI_CONDITION_LABELS, BIL_CONDITION_LABELS)

all_periods <- mean_across_stance %>% distinct(period)
all_periods
pre_post_periods <- c("Late Baseline", "Early Post Adapt")
# pre_post_periods <- c("Late Baseline", "end stop")

```


# Stiffness Data
## Creation
```{r}

stiffness_data <- mean_across_stance %>% 
  filter(axis == "X") %>%  # interested in DF
  select(-axis) %>% 
  filter(period %in% pre_post_periods) %>%  # reduce the size of the data to manage
  mutate(period = factor(period, levels=c("Late Baseline", "Early Post Adapt"))) %>% 
  filter(variable %in% c("IPSI_ANKLE_ANGLE", "IPSI_ANKLE_MOMENT")) %>% 
  pivot_wider(names_from = variable,values_from = value) %>% 
  mutate(IPSI_ANKLE_MOMENT = -IPSI_ANKLE_MOMENT)

```

## Individual Quasi-Stiffness Curves
```{r fig.width=6, fig.height=10}

stiffness_data %>% 
  filter(subject == "S10") %>%
  ggplot(aes(x = IPSI_ANKLE_ANGLE, y = IPSI_ANKLE_MOMENT, color = period))+
  geom_path()+
  facet_grid(rows = vars(condition), cols = vars(stance_side))

```

## Overall Mean Stiffness Curves

Note that this does not really mean much because it is smoothing over the discrete phases. Just gives a general sense of things.
```{r fig.width=6, fig.height=10}
stiffness_data %>% 
  group_by(condition, period, stance_side, normalized_time) %>% 
  summarize(IPSI_ANKLE_ANGLE = mean(IPSI_ANKLE_ANGLE),
            IPSI_ANKLE_MOMENT = mean(IPSI_ANKLE_MOMENT)) %>% 
  ggplot(aes(x = IPSI_ANKLE_ANGLE, y = IPSI_ANKLE_MOMENT, color = period))+
  geom_path()+
  facet_grid(rows = vars(condition), cols = vars(stance_side))
```

# Key Event Identification

This is where things get fun. Going to use mean_across_stance to pull out ankle angle, VGRF and APGRF. These will be used to identify 3 key phases:


## Point 1: Entering Dorsiflexion

First max plantarflexion angle. Note that given the definition of things here, this is calculated as the min. 

### Calculate Point

```{r}
pt_1_entering_dorsiflexion <- stiffness_data %>% 
  group_by(subject, condition, period, stance_side) %>%
  filter(normalized_time<50) %>% 
  slice(which.min(IPSI_ANKLE_ANGLE)) %>% 
  rename(max_PF_angle_time = normalized_time,
         max_PF_angle = IPSI_ANKLE_ANGLE) %>% 
  mutate(pt_1_entering_dorsiflexion_time = max_PF_angle_time)
```

### Visually Check Results
```{r, fig.width=6, fig.height=30}

stiffness_data %>% 
  # filter(subject == sample_subject) %>% 
  ggplot(aes(x= normalized_time,y = IPSI_ANKLE_ANGLE))+
  geom_path()+
  geom_point(data = pt_1_entering_dorsiflexion,
             aes(x =max_PF_angle_time, y = max_PF_angle),
             color="green")+
  facet_grid(rows = vars(subject, period), cols = vars(condition, stance_side)) 


```


## Point 2: Enter Dual Phase

### Reformat GRF Data 

```{r}
grf_data <- mean_across_stance %>% 
  filter(period %in% pre_post_periods) %>% 
  filter(variable == "IPSI_GRF") %>% 
  mutate(period = factor(period, levels=c("Late Baseline", "Early Post Adapt"))) %>% 
  pivot_wider(names_from = axis, values_from = value) %>% 
  # select(-X) %>% 
  rename(VGRF = Z,
         APGRF = Y) 
```



### Find Critical Points and Average
```{r}
find_local_min_VGRF_time <- function(data) {
  # requires data be grouped: group_by(subject, condition, period, stance_side)
  # Find peak in first half
  first_peak <- data %>%
    filter(normalized_time <= 50) %>%
    slice(which.max(VGRF))
  
  # Find peak in second half
  second_peak <- data %>%
    filter(normalized_time > 50) %>%
    slice(which.max(VGRF))
  
  # Find minimum between the two peaks
  central_min <- data %>%
    filter(normalized_time > first_peak$normalized_time,
           normalized_time < second_peak$normalized_time) %>%
    slice(which.min(VGRF)) %>%
    select(normalized_time, VGRF) %>% 
    rename(local_min_VGRF_time=normalized_time,
           local_min_VGRF = VGRF)
  
  return(central_min)
}


find_APGRF_crossover_time <- function(data) {
  # requires data be grouped: group_by(subject, condition, period, stance_side)
  
  # look in the middle range, find where the absolute value "bounces" off of zero (i.e. the minimum)
  crossover <- data %>%    
  filter(normalized_time >= 25, normalized_time <= 75) %>%
  slice(which.min(abs(APGRF))) %>% 
  select(normalized_time, APGRF) %>% 
  rename(APGRF_crossover_time = normalized_time,
         APGRF_crossover = APGRF)
  
  
  return(crossover)
 
} 

pt_2_enter_dual_phase <- grf_data %>% 
  group_by(subject,order, condition, period, stance_side) %>%
  nest() %>%
  mutate(local_min_VGRF_time = map(data, find_local_min_VGRF_time),
         APGRF_crossover_time = map(data, find_APGRF_crossover_time)) %>%
  select(-data) %>% 
  unnest(cols = c(local_min_VGRF_time, APGRF_crossover_time)) %>% 
  mutate(pt_2_enter_dual_phase_time = (APGRF_crossover_time + local_min_VGRF_time)/2) %>% 
  ungroup()

```


### Visually Check Results
```{r, fig.width=6, fig.height=30}

# VGRF plot
p1 <- grf_data  %>% 
  # filter(subject==sample_subject) %>%
  ggplot() +
  facet_grid(rows = vars(subject, period), cols = vars(condition, stance_side)) +
  geom_line(aes(x = normalized_time, y = VGRF)) +
  geom_point(data = pt_2_enter_dual_phase,
             aes(x = local_min_VGRF_time, y = local_min_VGRF), 
             color = "red", size = 2)

# APGRF plot
p2 <- grf_data %>% 
  # filter(subject==sample_subject) %>%
  ggplot() +
  facet_grid(rows = vars(subject, period), cols = vars(condition, stance_side)) +
  geom_line(aes(x = normalized_time, y = APGRF)) +
  geom_point(data = pt_2_enter_dual_phase,
             aes(x = APGRF_crossover_time, y = APGRF_crossover), 
             color = "blue", size = 2)
# Display plots
p1
p2  
  
```


## Point 3: Enter Falling

Midpoint of peak DF angle and moment. Keep in mind that this must happen AFTER point 2, so I can use that to narrow things down for the handful of weird people.


```{r, fig.width=6, fig.height=30}

peak_df_angle <- stiffness_data %>% 
  group_by(subject, condition, period, stance_side) %>%
  left_join(pt_2_enter_dual_phase) %>% 
  filter(normalized_time>pt_2_enter_dual_phase_time) %>% 
  slice(which.max(IPSI_ANKLE_ANGLE)) %>% 
  rename(peak_df_angle_time = normalized_time,
         peak_df_angle = IPSI_ANKLE_ANGLE)
  
stiffness_data %>% 
  ggplot(aes(x= normalized_time,y = IPSI_ANKLE_ANGLE))+
  geom_path()+
  geom_point(data = peak_df_angle,
             aes(x =peak_df_angle_time, y = peak_df_angle),
             color="blue")+
  facet_grid(rows = vars(subject, period), cols = vars(condition, stance_side)) 

peak_df_moment <- stiffness_data %>% 
  group_by(subject, condition, period, stance_side) %>%
  left_join(pt_2_enter_dual_phase) %>% 
  filter(normalized_time>pt_2_enter_dual_phase_time) %>% 
  slice(which.max(IPSI_ANKLE_MOMENT)) %>% 
  rename(peak_df_moment_time = normalized_time,
         peak_df_moment = IPSI_ANKLE_MOMENT)

stiffness_data %>% 
  ggplot(aes(x= normalized_time,y = IPSI_ANKLE_MOMENT))+
  geom_path()+
  geom_point(data = peak_df_moment,
             aes(x =peak_df_moment_time, y = peak_df_moment),
             color="red")+
  facet_grid(rows = vars(subject, period), cols = vars(condition, stance_side)) 


pt_3_enter_falling <- peak_df_angle %>% 
  left_join(peak_df_moment) %>% 
  select(-starts_with("pt_")) %>%  # don't want part 2 cluttering up
  mutate(pt_3_enter_falling_time = (peak_df_angle_time + peak_df_moment_time)/2)
  
```

Note that Pt 4 is toe off, which is just 100%.


# Merge Key Points into single Dataframe

```{r}
  
all_key_points <- pt_1_entering_dorsiflexion %>% 
  left_join(pt_2_enter_dual_phase, by = join_by(subject, order, condition, period, stance_side)) %>%
  left_join(pt_3_enter_falling, by = join_by(subject, order, condition, period, stance_side)) %>% 
  select(subject, 
         order, 
         condition, 
         period, 
         stance_side,
         starts_with("pt_"))

```

# Assign Phase Based on Key Points


```{r}

stiffness_with_phase <- stiffness_data %>% 
  ungroup() %>% 
  left_join(all_key_points) %>% 
  mutate(Phase = case_when(
    normalized_time < pt_1_entering_dorsiflexion_time ~ "Initial",
    normalized_time >= pt_1_entering_dorsiflexion_time & normalized_time < pt_2_enter_dual_phase_time ~ "Dorsiflexion",
    normalized_time >= pt_2_enter_dual_phase_time & normalized_time < pt_3_enter_falling_time ~ "Dual Flexion",
    normalized_time >= pt_3_enter_falling_time ~ "Falling",
    TRUE ~ "None"  # catch any other cases
  )) %>% 
  mutate(Phase = factor(Phase, levels = c("Initial", "Dorsiflexion", "Dual Flexion", "Falling", "None")))
  
  
```

```{r}
# Update phase_stiffness to include intercepts
phase_stiffness <- stiffness_with_phase %>%
  filter(Phase != "Initial") %>% 
  group_by(subject, condition, period, stance_side, Phase) %>%
  summarise(
    stiffness = coef(lm(IPSI_ANKLE_MOMENT ~ IPSI_ANKLE_ANGLE))[2],  # slope
    intercept = coef(lm(IPSI_ANKLE_MOMENT ~ IPSI_ANKLE_ANGLE))[1],   # intercept
    r_squared = summary(lm(IPSI_ANKLE_MOMENT ~ IPSI_ANKLE_ANGLE))$r.squared
  ) %>%
  ungroup()

# Update the plotting code to use the calculated intercepts
phase_endpoints <- stiffness_with_phase %>%
  group_by(subject, condition, period, stance_side, Phase) %>%
  summarize(
    x_start = min(IPSI_ANKLE_ANGLE),
    x_end = max(IPSI_ANKLE_ANGLE)
  )

phase_lines <- phase_endpoints %>%
  left_join(phase_stiffness)

# Plot with proper intercepts
stiffness_with_phase %>%
  filter(subject == "S4") %>% 
  ggplot(aes(x = IPSI_ANKLE_ANGLE, y = IPSI_ANKLE_MOMENT)) +
  geom_path(aes(color = Phase)) +
  geom_segment(data = phase_lines %>% filter(subject == "S4"),
               aes(x = x_start, 
                   xend = x_end,
                   y = intercept + stiffness * x_start,
                   yend = intercept + stiffness * x_end,
                   color = Phase),
               linetype = "dashed",
               size = 1) +
  facet_grid(rows = vars(condition), cols = vars(stance_side, period)) +
  theme_minimal()
```

```{r}
phase_stiffness %>%
  filter(condition %in% c("bbp", "bpp")) %>% 
  ggplot(aes(x = Phase, y = stiffness, color = period)) +
  geom_point(position = position_dodge(width = 0.3), size = 1) +
  facet_grid(rows = vars(condition), cols = vars(stance_side)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Stiffness (k)", 
       color = "Stance Side")



# Mac: this is something that you are doing for convenience but is really dirty
phase_stiffness_for_test <- phase_stiffness %>% 
  filter(subject != "S8") %>% # seems to be a problem for some reason
  ungroup() %>% 
  filter(condition %in% c("bbp", "bpp")) %>% 
  group_by(subject, condition, period, Phase) %>% 
  summarize(stiffness = mean(stiffness)) 

phase_stiffness_for_test %>%
  group_by(subject, condition, period, Phase) %>% 
  summarize(stiffness = mean(stiffness)) %>% 
  ggplot(aes(x = Phase, y = stiffness, color = period)) +
  geom_point(position = position_dodge(width = 0.3), size = 1) +
  facet_grid(rows = vars(condition)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Stiffness (k)", 
       color = "Period")

```

```{r}
library(lme4)
library(lmerTest)  # for p-values in mixed models

# Run separate models for each Phase since they represent different biomechanical events
for(current_phase in unique(phase_stiffness_for_test$Phase)) {
  
  cat("\nAnalysis for", current_phase, "phase:\n")
  
  # Subset data for current phase
  phase_data <- phase_stiffness_for_test %>%
    filter(Phase == current_phase,
           condition %in% c("bbp", "bpp"))
  
  # Fit mixed model
  model <- lmer(stiffness ~ period * condition + (1|subject), 
                data = phase_data)
  
  # Print ANOVA results
  print(anova(model))
}
```

```{r}


# For Dorsiflexion phase
dorsi_data <- phase_stiffness_for_test %>%
  filter(Phase == "Dorsiflexion",
         condition %in% c("bbp", "bpp"))
dorsi_model <- lmer(stiffness ~ period * condition + (1|subject), data = dorsi_data)

cat("\nDorsiflexion Phase - Within Condition Comparisons:\n")
dorsi_emm <- emmeans(dorsi_model, ~ period | condition)  # Note the | operator
pairs(dorsi_emm, adjust = "bonf")

# For Dual Flexion Phase
dual_flexion_data <- phase_stiffness_for_test %>%
  filter(Phase == "Dual Flexion",
         condition %in% c("bbp", "bpp"))
dual_flexion_model <- lmer(stiffness ~ period * condition + (1|subject), data = dual_flexion_data)
cat("\nDual Flexion Phase - Within Condition Comparisons:\n")
dual_flexion_emm <- emmeans(dual_flexion_model, ~ period | condition)  # Note the | operator
pairs(dual_flexion_emm, adjust = "bonf")

# For Falling phase
falling_data <- phase_stiffness_for_test %>%
  filter(Phase == "Falling",
         condition %in% c("bbp", "bpp"))
falling_model <- lmer(stiffness ~ period * condition + (1|subject), data = falling_data)

cat("\nFalling Phase - Within Condition Comparisons:\n")
falling_emm <- emmeans(falling_model, ~ period | condition)  # Note the | operator
pairs(falling_emm, adjust = "bonf")
```

# thoughts for tomorrow

Here's a summary plan for tomorrow:

ANALYSIS PLAN - Bilateral Conditions Only
----------------------------------------
1. Data Preprocessing:
- Filter for only conditions starting with 'b'
- Remove subjects with low number of points (define threshold)
- Average mean_stance data across sides at the beginning of analysis

2. Main Analysis Steps:
- Calculate phase stiffness using averaged bilateral data
- Run mixed effects models for each phase
- Conduct within-condition post-hoc comparisons
- Examine Dual Flexion phase in more detail

3. Code Structure:
```r
# Initial data prep
bilateral_data <- original_data %>%
  filter(str_detect(condition, "^b")) %>%
  group_by([subject, other_relevant_vars]) %>%
  # Add minimum points threshold
  # Average across sides
  
# Continue with similar analysis structure from today
# but using this newly preprocessed dataset
```

4. Questions to Consider:
- What threshold for minimum points?
- Does averaging across sides reduce variability?
- Does this change our understanding of the Dual Flexion results?